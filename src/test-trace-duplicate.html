<!DOCTYPE html>
<html>
<head>
    <title>Trace Duplicate Processing</title>
    <style>
        body {
            background: #1a1a1a;
            color: #e5e5e7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
        }
        
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>🔍 Trace Duplicate Processing</h1>
    
    <p>This will trace exactly what's happening when processing math.</p>
    
    <button onclick="runTrace()">🚀 Run Trace</button>
    <button onclick="clearConsole()">🗑️ Clear Console</button>
    
    <h3>Console Output:</h3>
    <div id="console-output" class="console-output">Click "Run Trace" to see output...</div>
    
    <h3>Result:</h3>
    <div id="result" style="background: #2a2a2a; padding: 15px; border-radius: 4px; margin: 10px 0;">
        Result will appear here...
    </div>

    <!-- Load KaTeX -->
    <link rel="stylesheet" href="../node_modules/katex/dist/katex.min.css" onerror="this.href='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'">
    <script src="../node_modules/katex/dist/katex.min.js" onerror="document.write('<script src=\'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js\'><\/script>')"></script>

    <script type="module">
        import { enhancedContentProcessor } from './components/enhanced-content-processor.js';
        
        // Capture console output
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalTrace = console.trace;
        
        function addToConsole(type, ...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            consoleOutput.textContent += line;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Also call original
            if (type === 'log') originalLog.apply(console, args);
            else if (type === 'warn') originalWarn.apply(console, args);
            else if (type === 'error') originalError.apply(console, args);
            else if (type === 'trace') originalTrace.apply(console, args);
        }
        
        console.log = (...args) => addToConsole('log', ...args);
        console.warn = (...args) => addToConsole('warn', ...args);
        console.error = (...args) => addToConsole('error', ...args);
        console.trace = (...args) => addToConsole('trace', ...args);
        
        window.runTrace = () => {
            consoleOutput.textContent = '';
            
            const testInput = 'The equation $E = mc^2$ is famous.';
            console.log('🧪 Starting trace with input:', testInput);
            
            try {
                const result = enhancedContentProcessor.processContentSync(testInput);
                console.log('🎯 Final result:', result);
                
                document.getElementById('result').innerHTML = result;
                
                // Analyze result
                const rawMathCount = (result.match(/\$[^$]+\$/g) || []).length;
                const processedMathCount = (result.match(/math-inline|math-block-container|katex/g) || []).length;
                
                console.log('📊 Analysis:');
                console.log('- Raw math patterns:', rawMathCount);
                console.log('- Processed math elements:', processedMathCount);
                
                if (rawMathCount === 0 && processedMathCount > 0) {
                    console.log('✅ SUCCESS: No duplicates!');
                } else if (rawMathCount > 0 && processedMathCount > 0) {
                    console.log('❌ DUPLICATE: Both raw and processed math found!');
                } else {
                    console.log('⚠️ UNEXPECTED: Unusual result pattern');
                }
                
            } catch (error) {
                console.error('❌ Error during processing:', error);
            }
        };
        
        window.clearConsole = () => {
            consoleOutput.textContent = 'Console cleared...';
        };
        
        // Auto-run after delay
        setTimeout(() => {
            console.log('🚀 Auto-running trace...');
            runTrace();
        }, 2000);
    </script>
</body>
</html>