<!DOCTYPE html>
<html>
<head>
    <title>Duplicate Math Fix Test</title>
    <style>
        body {
            background: #1a1a1a;
            color: #e5e5e7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }
        
        .input {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            color: #4fc3f7;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .output {
            background: rgba(76, 175, 80, 0.1);
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #4caf50;
            margin: 10px 0;
        }
        
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔧 Duplicate Math Rendering Fix Test</h1>
    
    <p>This test checks that math is rendered only once (the good version) and not duplicated.</p>
    
    <div class="test-case">
        <h3>Test 1: Simple Inline Math</h3>
        <div class="input">The equation $E = mc^2$ is famous.</div>
        <button onclick="test1()">Test</button>
        <div id="output1" class="output">Click test to see result...</div>
    </div>
    
    <div class="test-case">
        <h3>Test 2: Display Math</h3>
        <div class="input">$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$</div>
        <button onclick="test2()">Test</button>
        <div id="output2" class="output">Click test to see result...</div>
    </div>
    
    <div class="test-case">
        <h3>Test 3: Math with Asterisks (Potential Conflict)</h3>
        <div class="input">The formula $a * b * c$ should not conflict with *italic* text.</div>
        <button onclick="test3()">Test</button>
        <div id="output3" class="output">Click test to see result...</div>
    </div>
    
    <div class="test-case">
        <h3>Test 4: Math Code Block</h3>
        <div class="input">```math
\frac{a}{b} + \frac{c}{d} = \frac{ad + bc}{bd}
```</div>
        <button onclick="test4()">Test</button>
        <div id="output4" class="output">Click test to see result...</div>
    </div>
    
    <div class="test-case">
        <h3>Test 5: Mixed Content</h3>
        <div class="input">Here's **bold text** and $x^2$ math and *italic* text.</div>
        <button onclick="test5()">Test</button>
        <div id="output5" class="output">Click test to see result...</div>
    </div>
    
    <button onclick="runAllTests()" style="background: #4caf50; font-size: 16px; padding: 12px 24px;">🚀 Run All Tests</button>

    <!-- Load KaTeX -->
    <link rel="stylesheet" href="../node_modules/katex/dist/katex.min.css" onerror="this.href='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'">
    <script src="../node_modules/katex/dist/katex.min.js" onerror="document.write('<script src=\'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js\'><\/script>')"></script>

    <script type="module">
        import { enhancedContentProcessor } from './components/enhanced-content-processor.js';
        
        window.enhancedContentProcessor = enhancedContentProcessor;
        
        function processAndShow(input, outputId) {
            const processed = enhancedContentProcessor.processContentSync(input);
            document.getElementById(outputId).innerHTML = processed;
            
            // Check for duplicates
            const outputEl = document.getElementById(outputId);
            const mathElements = outputEl.querySelectorAll('.katex, .math-block-container, .math-inline');
            const rawMathCount = (processed.match(/\$[^$]+\$/g) || []).length;
            
            console.log(`Test ${outputId}:`);
            console.log('- Processed math elements:', mathElements.length);
            console.log('- Raw math patterns remaining:', rawMathCount);
            console.log('- Should be: math elements > 0, raw patterns = 0');
            
            if (rawMathCount > 0) {
                console.warn('⚠️ Raw math patterns still present - possible duplicate rendering!');
            } else {
                console.log('✅ No raw math patterns - good!');
            }
        }
        
        window.test1 = () => processAndShow('The equation $E = mc^2$ is famous.', 'output1');
        window.test2 = () => processAndShow('$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$', 'output2');
        window.test3 = () => processAndShow('The formula $a * b * c$ should not conflict with *italic* text.', 'output3');
        window.test4 = () => processAndShow('```math\n\\frac{a}{b} + \\frac{c}{d} = \\frac{ad + bc}{bd}\n```', 'output4');
        window.test5 = () => processAndShow('Here\\'s **bold text** and $x^2$ math and *italic* text.', 'output5');
        
        window.runAllTests = () => {
            test1();
            setTimeout(test2, 100);
            setTimeout(test3, 200);
            setTimeout(test4, 300);
            setTimeout(test5, 400);
        };
        
        // Auto-run tests after a delay
        setTimeout(() => {
            console.log('🧮 Auto-running duplicate fix tests...');
            runAllTests();
        }, 2000);
    </script>
</body>
</html>