<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Math Renderer Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e5e5e7;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 2em 0;
            padding: 1em;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .test-title {
            color: #007aff;
            font-weight: bold;
            margin-bottom: 1em;
        }
        .test-input {
            background: #333;
            padding: 1em;
            border-radius: 4px;
            margin: 0.5em 0;
            font-family: monospace;
            color: #4fc3f7;
        }
        .test-output {
            background: #1e1e1e;
            padding: 1em;
            border-radius: 4px;
            margin: 0.5em 0;
            border-left: 3px solid #007aff;
        }
        .stats {
            background: #2d2d2d;
            padding: 1em;
            border-radius: 8px;
            margin: 1em 0;
        }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 0.5em 1em;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5em;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üßÆ Unified Math Renderer Test</h1>
    
    <div class="stats" id="stats">
        <strong>System Status:</strong> <span id="status">Loading...</span><br>
        <strong>KaTeX Ready:</strong> <span id="katex-status">Checking...</span><br>
        <strong>Cache Size:</strong> <span id="cache-size">0</span><br>
        <strong>Processing ID:</strong> <span id="processing-id">0</span>
    </div>

    <button onclick="runAllTests()">üß™ Run All Tests</button>
    <button onclick="clearCache()">üóëÔ∏è Clear Cache</button>
    <button onclick="updateStats()">üìä Update Stats</button>

    <div class="test-section">
        <div class="test-title">Test 1: Display Math</div>
        <div class="test-input">$$E = mc^2$$</div>
        <div class="test-output" id="test1-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 2: Inline Math</div>
        <div class="test-input">The equation $x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$ is the quadratic formula.</div>
        <div class="test-output" id="test2-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 3: Math Code Block</div>
        <div class="test-input">```math
\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
```</div>
        <div class="test-output" id="test3-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 4: LaTeX Environment</div>
        <div class="test-input">\begin{equation}
F = ma
\end{equation}</div>
        <div class="test-output" id="test4-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 5: Power Equations</div>
        <div class="test-input">Einstein's famous equation E = mc^2 shows mass-energy equivalence.</div>
        <div class="test-output" id="test5-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 6: Mixed Content</div>
        <div class="test-input">Here's some text with inline math $a^2 + b^2 = c^2$ and display math:

$$\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}$$

And a code block:
```math
\nabla \cdot \mathbf{E} = \frac{\rho}{\epsilon_0}
```</div>
        <div class="test-output" id="test6-output">Not processed yet</div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 7: Duplicate Processing Prevention</div>
        <div class="test-input">This will test if already processed content is handled correctly.</div>
        <div class="test-output" id="test7-output">Not processed yet</div>
        <button onclick="testDuplicateProcessing()">üîÑ Test Duplicate Processing</button>
    </div>

    <script type="module">
        import { 
            unifiedMathRenderer, 
            processMathContent, 
            isKaTeXReady, 
            clearMathCache, 
            getMathStats 
        } from './unified-math-renderer.js';

        // Make functions available globally for button clicks
        window.unifiedMathRenderer = unifiedMathRenderer;
        window.processMathContent = processMathContent;
        window.isKaTeXReady = isKaTeXReady;
        window.clearMathCache = clearMathCache;
        window.getMathStats = getMathStats;

        // Test data
        const tests = [
            { id: 'test1', content: '$$E = mc^2$$' },
            { id: 'test2', content: 'The equation $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ is the quadratic formula.' },
            { id: 'test3', content: '```math\n\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}\n```' },
            { id: 'test4', content: '\\begin{equation}\nF = ma\n\\end{equation}' },
            { id: 'test5', content: 'Einstein\'s famous equation E = mc^2 shows mass-energy equivalence.' },
            { id: 'test6', content: `Here's some text with inline math $a^2 + b^2 = c^2$ and display math:

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

And a code block:
\`\`\`math
\\nabla \\cdot \\mathbf{E} = \\frac{\\rho}{\\epsilon_0}
\`\`\`` }
        ];

        // Global functions for buttons
        window.runAllTests = async function() {
            console.log('üß™ Running all tests...');
            
            for (const test of tests) {
                try {
                    console.log(`Testing ${test.id}...`);
                    const result = processMathContent(test.content);
                    document.getElementById(`${test.id}-output`).innerHTML = result;
                    console.log(`‚úÖ ${test.id} completed`);
                } catch (error) {
                    console.error(`‚ùå ${test.id} failed:`, error);
                    document.getElementById(`${test.id}-output`).innerHTML = `<span style="color: #f44336;">Error: ${error.message}</span>`;
                }
            }
            
            updateStats();
            console.log('üß™ All tests completed');
        };

        window.clearCache = function() {
            clearMathCache();
            updateStats();
            console.log('üóëÔ∏è Cache cleared');
        };

        window.updateStats = function() {
            const stats = getMathStats();
            document.getElementById('status').textContent = 'Running';
            document.getElementById('katex-status').textContent = stats.isKaTeXReady ? '‚úÖ Ready' : '‚ùå Not Ready';
            document.getElementById('cache-size').textContent = stats.cacheSize;
            document.getElementById('processing-id').textContent = stats.processingId;
        };

        window.testDuplicateProcessing = function() {
            const testContent = '$$E = mc^2$$';
            
            // Process once
            const result1 = processMathContent(testContent);
            console.log('First processing result:', result1.substring(0, 100) + '...');
            
            // Process the result again (should be detected as already processed)
            const result2 = processMathContent(result1);
            console.log('Second processing result:', result2.substring(0, 100) + '...');
            
            // Check if they're the same (indicating duplicate detection worked)
            const isDuplicateDetected = result1 === result2;
            
            document.getElementById('test7-output').innerHTML = `
                <strong>Duplicate Detection Test:</strong><br>
                <strong>Result:</strong> ${isDuplicateDetected ? '‚úÖ PASSED' : '‚ùå FAILED'}<br>
                <strong>First processing length:</strong> ${result1.length}<br>
                <strong>Second processing length:</strong> ${result2.length}<br>
                <strong>Results identical:</strong> ${isDuplicateDetected ? 'Yes' : 'No'}
            `;
        };

        // Initialize on load
        window.addEventListener('load', async () => {
            console.log('üßÆ Initializing unified math renderer test...');
            
            // Wait a bit for the renderer to initialize
            setTimeout(() => {
                updateStats();
                console.log('‚úÖ Test page ready');
            }, 1000);
        });

        // Listen for math ready event
        window.addEventListener('unified-math-ready', () => {
            console.log('üßÆ Unified math renderer is ready!');
            updateStats();
        });
    </script>
</body>
</html>