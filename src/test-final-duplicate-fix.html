<!DOCTYPE html>
<html>
<head>
    <title>Final Duplicate Fix Test</title>
    <style>
        body {
            background: #1a1a1a;
            color: #e5e5e7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
        }
        
        .test {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }
        
        .result {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #4caf50;
        }
        
        .analysis {
            background: rgba(0, 122, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>üîß Final Duplicate Fix Test</h1>
    
    <p>This test checks if ALL math processors are working correctly without duplicates.</p>
    
    <div class="test">
        <h3>Test 1: Simple Inline Math</h3>
        <p><strong>Input:</strong> <code>The equation $E = mc^2$ is famous.</code></p>
        <button onclick="test1()">Test</button>
        <div id="result1" class="result">Click test to see result...</div>
        <div id="analysis1" class="analysis">Analysis will appear here...</div>
    </div>
    
    <div class="test">
        <h3>Test 2: Display Math</h3>
        <p><strong>Input:</strong> <code>$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$</code></p>
        <button onclick="test2()">Test</button>
        <div id="result2" class="result">Click test to see result...</div>
        <div id="analysis2" class="analysis">Analysis will appear here...</div>
    </div>
    
    <div class="test">
        <h3>Test 3: Multiple Math Expressions</h3>
        <p><strong>Input:</strong> <code>Here's $x^2$ and also $$\frac{a}{b}$$ in one message.</code></p>
        <button onclick="test3()">Test</button>
        <div id="result3" class="result">Click test to see result...</div>
        <div id="analysis3" class="analysis">Analysis will appear here...</div>
    </div>
    
    <div class="test">
        <h3>Console Messages</h3>
        <p>Check the browser console for:</p>
        <ul>
            <li>‚úÖ "marked.min.js: Math processing disabled"</li>
            <li>‚úÖ "EquationRenderer.processContent is DISABLED"</li>
            <li>‚úÖ Math processing messages from mathBlockProcessor</li>
        </ul>
    </div>
    
    <button onclick="runAllTests()" style="background: #4caf50; font-size: 16px; padding: 12px 24px;">üöÄ Run All Tests</button>
    <button onclick="clearResults()" style="background: #f44336;">üóëÔ∏è Clear Results</button>

    <!-- Load KaTeX -->
    <link rel="stylesheet" href="../node_modules/katex/dist/katex.min.css" onerror="this.href='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'">
    <script src="../node_modules/katex/dist/katex.min.js" onerror="document.write('<script src=\'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js\'><\/script>')"></script>

    <script type="module">
        import { enhancedContentProcessor } from './components/enhanced-content-processor.js';
        import './marked.min.js'; // This should now have disabled math processing
        
        function analyzeResult(input, result, analysisId) {
            const rawMathCount = (result.match(/\$[^$]+\$/g) || []).length;
            const processedMathCount = (result.match(/math-inline|math-block-container|katex/g) || []).length;
            
            let status = '';
            let statusClass = '';
            
            if (rawMathCount === 0 && processedMathCount > 0) {
                status = '‚úÖ SUCCESS: No duplicates, math processed correctly!';
                statusClass = 'success';
            } else if (rawMathCount > 0 && processedMathCount > 0) {
                status = '‚ùå DUPLICATE: Both raw and processed math found!';
                statusClass = 'error';
            } else if (rawMathCount > 0 && processedMathCount === 0) {
                status = '‚ö†Ô∏è NO PROCESSING: Only raw math found!';
                statusClass = 'warning';
            } else {
                status = '‚ö†Ô∏è NO MATH: No math expressions detected';
                statusClass = 'warning';
            }
            
            document.getElementById(analysisId).innerHTML = `
                <div class="${statusClass}"><strong>${status}</strong></div>
                <div>Raw math patterns: ${rawMathCount}</div>
                <div>Processed math elements: ${processedMathCount}</div>
                <div>Input length: ${input.length} chars</div>
                <div>Output length: ${result.length} chars</div>
            `;
            
            console.log(`Analysis for ${analysisId}:`, {
                status,
                rawMathCount,
                processedMathCount,
                input: input.substring(0, 50),
                outputPreview: result.substring(0, 100)
            });
        }
        
        function processAndShow(input, resultId, analysisId) {
            console.log(`üß™ Testing: ${input}`);
            
            const result = enhancedContentProcessor.processContentSync(input);
            document.getElementById(resultId).innerHTML = result;
            
            analyzeResult(input, result, analysisId);
        }
        
        window.test1 = () => processAndShow('The equation $E = mc^2$ is famous.', 'result1', 'analysis1');
        window.test2 = () => processAndShow('$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$', 'result2', 'analysis2');
        window.test3 = () => processAndShow('Here\\'s $x^2$ and also $$\\frac{a}{b}$$ in one message.', 'result3', 'analysis3');
        
        window.runAllTests = () => {
            console.log('üöÄ Running all duplicate fix tests...');
            test1();
            setTimeout(test2, 100);
            setTimeout(test3, 200);
        };
        
        window.clearResults = () => {
            ['result1', 'result2', 'result3'].forEach(id => {
                document.getElementById(id).innerHTML = 'Click test to see result...';
            });
            ['analysis1', 'analysis2', 'analysis3'].forEach(id => {
                document.getElementById(id).innerHTML = 'Analysis will appear here...';
            });
        };
        
        // Auto-run tests after delay
        setTimeout(() => {
            console.log('üîß Auto-running final duplicate fix tests...');
            runAllTests();
        }, 2000);
    </script>
</body>
</html>